# 故障转移

## 故障转移

### 故障发现
#### 1. 主观下线(pfail)
> 指某个节点认为另一个节点不可用，即下线状态，这个状态并不是最终的故障判定，只能代表一个节点的意见，可能存在误判

流程：
1. 节点a发送ping给节点b，如果收到pong则正常，a更新最近一次与b的通信时间
2. 如果节点a与节点b通信出现问题则断开连接，下次会进行重连，如果一直通信失败，则节点a记录的与节点b的最后通信时间将无法更新
3. 节点a内的定时任务检测到与节点b最后通信时间高于`cluster-node-timeout`时，更新本地对节点b的状态为主观下线

当某个节点判断另一个节点主观下线后，相应的节点状态会随消息在集群内传播；
当接收接收发现消息体中含有主观下线的节点状态时，会将故障节点保存到本地的下线报告链表中；
通过Gossip消息传播，集群内节点不断收集到故障节点的下线报告。当半数以上持有槽的主节点都标记某个节点主观下线时，触发客观下线流程；

#### 2. 客观下线(fail)
> 指标记一个节点真正的下线；集群内多个节点都认为该节点不可用，从而达成共识的结果。如果是持有槽的主节点故障，需要为该节点进行故障转移

### 故障恢复

故障节点变为客观下线后，如果下线节点是持有槽的主节点，则需要在它的从节点中选出一个替换他，从而保证集群的高可用

流程
1. 资格检查
2. 准备选举时间
3. 发起选举
4. 选举投票
5. 替换故障节点



