# 请求路由

## 请求路由
### MOVED重定向

在集群模式下，redis接受任何键相关命令时首先计算出对应的槽，根据槽找出对应节点；
如果节点是本身，则执行键命令；
否则回复`MOVED`重定向错误，通知客户端请求正确的节点；
这个过程称为`MOVED重定向`

如果使用`redis-cli`，可以加入`-c`参数支持自动重定向
`redis-cli -p 6379 -c`



### smart客户端
原理：smart客户端通过在内部维护slot->node的映射关系，本地就可以实现键到节点的查找，从而避免`MOVED`重定向带来的二次操作，保证IO效率的最大化
各个语言的客户端可在官网查找: <http://redis.io/clients>

- 初始化过程：
1. 客户端初始化是会选择一个运行节点，初始化槽和节点的映射关系；
2. 解析cluster slots结果缓存在本地，并为每个节点创建唯一的连接池；
- 键执行流程
1. 计算slot并根据slots缓存获取目标节点连接，发送命令
2. 如果出现连接错误，使用随机连接重新执行键命令，
3. 捕获到`MOVED`重定向错误时，使用`cluster slots`命令更新slots缓存
4. 重复1～3步，直到命令成功（超过5次未成功则报告异常）

### ASK重定向
客户端ASk重定向流程：
redis集群支持在线迁移槽和数据来完成水平伸缩，当slot对应的数据重源节点到目标节点的迁移过程中，客户端需要做到智能识别，保证键命令可正常执行；
例如当一个slot数据从源节点迁移到目标节点时，期间可能出现一部分数据在源节点，而另一部分在目标节点；
当出现上述情况时，客户端键命令执行流程将发生变化：
1. 客户端根据本地slots缓存发送命令到源节点，如果存在键对象则直接执行并返回结果给客户端
2. 如果键对象不存在，则可能存在于目标节点，这时源节点会回复ACK重定向异常
3. 客户端从ASK重定向异常提取出目标节点信息，发送asking命令到目标节点打开客户端连接表示，再执行键命令；如果存在则执行，不存在则返回不存在信息


ASk重定向说明集群正在进行slot数据迁移，客户端无法知道什么时候迁移完成，因此智能时临时性的重定向，客户端不会更新slots缓存；
但是MOVED重定向说明键对应的槽已经明确指定到新的节点，因此此时需要更新slots缓存








