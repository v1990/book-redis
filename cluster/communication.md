# 节点通信

## 节点通信
> 元数据：节点负责哪些槽，哪些数据，是否出现故障等状态信息

常见的元数据维护方式分为：集中式和P2P方式

redis集群采用P2P的`Gossip协议`,Gossip协议工作原理就是节点彼此不断通信交换信息，一段时间后所有节点就会知道集群完整的信息，这种方式类似于流言传播；

### 通信过程：
1. 集群中的每个节点都会单独开辟一个TCP通道，用于节点之间彼此通信，通信端口号在基础端口加上10000（如6380的通信端口为16380）
2. 每个节点在固定周期内通过特定规则选择几个节点发送ping消息
3. 接收到ping消息的节点回复pong响应
集群中的每个节点通过一定规则挑选要通信的节点，每个节点可能知道全部节点，也可能知道部分节点，只要这些节点彼此可以正常通信，最终他们会达到一致的状态。
当节点故障/新节点加入/主从角色变化/槽信息变更等事件发生时，通过不断的ping/pong消息通信，经过一段时间后所有节点都会知道整个集群的全部节点的最新状态，
从而达到集群同步的目的
### Gossip消息
Gossip协议的主要职责就是信息交换，信息交换的载体就是节点彼此发送的消息

常用的Gossip消息可分为：
- meet：用于通知新节点加入
- ping：集群内交换最频繁的消息，集群每个节点每秒向多个节点发送ping消息，用于检测节点是否在线和交换彼此状态信息
- pong：当接收到ping，meet消息时，作为响应消息给发送方确认消息正常通行，pong消息内部封装了自身状态数据，节点也可以向集群内广播自身的pong消息来通知整个集群对自身状态进行更新
- fail：当节点判定集群内另一个节点下线时，会向集群内广播一个fail消息，其他节点接收到fail消息之后把对应节点更新为下线状态
### 节点选择
redis集群内节点通信采用固定频率（定时任务：10次/秒）通过ping/pong进行节点消息交换
节点选择规则为：
- 每秒随机5次找出最久没通信的节点
- 最后通信时间大于node-timeout/2
发送的ping消息包括`节点自身消息`和`1/10其他节点消息`
